{"ast":null,"code":"import { takeUntil, debounceTime, concatMap, catchError } from 'rxjs/operators';\nimport { BaseComponent } from '@components/base/base.component';\nimport { AddCategoryModalComponent } from '@modals/add-category/add-category.component';\nimport { Subject } from 'rxjs';\nimport { fieldRemover } from '@utils/sanitizer';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ng-bootstrap/ng-bootstrap\";\nimport * as i2 from \"@services/alert.service\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"@services/store.service\";\nimport * as i5 from \"@services/category.service\";\nimport * as i6 from \"@services/auth.service\";\nimport * as i7 from \"@angular/common\";\nimport * as i8 from \"../../components/category-list/category-list.component\";\nimport * as i9 from \"@ngx-translate/core\";\nfunction CategoryComponent_div_3_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"div\", 7)(1, \"div\", 8)(2, \"div\", 9)(3, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function CategoryComponent_div_3_Template_button_click_3_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.createNewCategory());\n    });\n    i0.ɵɵelement(4, \"i\", 11);\n    i0.ɵɵtext(5);\n    i0.ɵɵpipe(6, \"translate\");\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelement(7, \"div\", 12);\n    i0.ɵɵelementStart(8, \"div\", 13)(9, \"div\", 14)(10, \"i\", 15);\n    i0.ɵɵlistener(\"click\", function CategoryComponent_div_3_Template_i_click_10_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.moveUpSubj.next(ctx_r1.selectedItem));\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(11, \"div\", 14)(12, \"i\", 16);\n    i0.ɵɵlistener(\"click\", function CategoryComponent_div_3_Template_i_click_12_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.moveDownSubj.next(ctx_r1.selectedItem));\n    });\n    i0.ɵɵelementEnd()()();\n    i0.ɵɵelementStart(13, \"div\", 17)(14, \"div\", 18)(15, \"div\", 14)(16, \"i\", 19);\n    i0.ɵɵlistener(\"click\", function CategoryComponent_div_3_Template_i_click_16_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.selectedItem ? ctx_r1.editCategory() : null);\n    });\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(17, \"button\", 20);\n    i0.ɵɵlistener(\"click\", function CategoryComponent_div_3_Template_button_click_17_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.removeCategory());\n    });\n    i0.ɵɵelement(18, \"i\", 21);\n    i0.ɵɵelementEnd()()()()();\n  }\n  if (rf & 2) {\n    const ctx_r1 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate1(\" \", i0.ɵɵpipeBind1(6, 10, \"categories.new_category\"), \" \");\n    i0.ɵɵadvance(5);\n    i0.ɵɵclassProp(\"disabled\", !ctx_r1.selectedItem);\n    i0.ɵɵadvance(2);\n    i0.ɵɵclassProp(\"disabled\", !ctx_r1.selectedItem);\n    i0.ɵɵadvance(4);\n    i0.ɵɵclassProp(\"disabled\", !ctx_r1.selectedItem);\n    i0.ɵɵadvance();\n    i0.ɵɵclassProp(\"btn-info\", !ctx_r1.selectedItem || (ctx_r1.selectedItem == null ? null : ctx_r1.selectedItem.children == null ? null : ctx_r1.selectedItem.children.length));\n    i0.ɵɵproperty(\"disabled\", !ctx_r1.selectedItem || (ctx_r1.selectedItem == null ? null : ctx_r1.selectedItem.children == null ? null : ctx_r1.selectedItem.children.length));\n  }\n}\nfunction CategoryComponent_hr_4_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"hr\", 22);\n  }\n}\nvar Move = /*#__PURE__*/function (Move) {\n  Move[Move[\"Up\"] = 1] = \"Up\";\n  Move[Move[\"Down\"] = 2] = \"Down\";\n  return Move;\n}(Move || {});\nexport let CategoryComponent = /*#__PURE__*/(() => {\n  class CategoryComponent extends BaseComponent {\n    constructor(modalServ, alertServ, route, storeService, catServ, authServ) {\n      super();\n      this.modalServ = modalServ;\n      this.alertServ = alertServ;\n      this.route = route;\n      this.storeService = storeService;\n      this.catServ = catServ;\n      this.authServ = authServ;\n      this.moveSub = new Subject();\n      this.direction = Move;\n      this.selectedItem = null;\n      // tslint:disable-next-line: variable-name\n      this._categories = [];\n      this.categoriesMap = new Map();\n      this.moveUpSubj = new Subject();\n      this.moveDownSubj = new Subject();\n      this.isAdmin = this.authServ.isAdmin();\n      this.configEvents();\n    }\n    get categories() {\n      return this._categories;\n    }\n    set categories(value) {\n      this._categories = value;\n      this.processCategories();\n    }\n    ngOnInit() {\n      this.route.paramMap.pipe(takeUntil(this.destroyed$)).subscribe(params => {\n        const location = params.get('location');\n        if (location == 'shop-page') {\n          this.storeService.getSidebarChange(true);\n          this.isAdmin = false;\n          this.storeId = localStorage.getItem('STORE_ID').toString();\n        }\n      });\n      if (this.isAdmin) {\n        this.catServ.getAdminCategories().pipe(takeUntil(this.destroyed$)).subscribe(res => {\n          this.categories = res.categories;\n        });\n      } else {\n        this.catServ.getCategories(this.storeId).pipe(takeUntil(this.destroyed$)).subscribe(res => {\n          this.categories = res.categories;\n        });\n      }\n    }\n    createNewCategory() {\n      const modal = this.modalServ.open(AddCategoryModalComponent, {\n        centered: true\n      });\n      const modalComp = modal.componentInstance;\n      modalComp.categories = this._categories;\n      modal.result.then(this.addNewItem.bind(this));\n    }\n    addNewItem(cat) {\n      this.categories.push(cat);\n      cat.siblings = this.categories;\n      cat.children = cat.children || [];\n    }\n    editCategory() {\n      const modal = this.modalServ.open(AddCategoryModalComponent, {\n        centered: true\n      });\n      const addModal = modal.componentInstance;\n      addModal.categories = this.categories;\n      addModal.data = this.selectedItem;\n      modal.result.then(this.editItem.bind(this));\n    }\n    editItem(editedCat) {\n      let item = this.selectedItem;\n      item = Object.assign(this.selectedItem, editedCat);\n      this.selectedItem = Object.assign(item, editedCat);\n    }\n    removeCategory() {\n      this.showConfirmDelete().then(() => this.catServ.deleteCategory(this.selectedItem.category_id).subscribe({\n        next: this.removeSelectedItem.bind(this),\n        error: console.error\n      }));\n    }\n    showConfirmDelete() {\n      return this.alertServ.showConfirm('modal.delete_category_title', 'modal.delete_category_content');\n    }\n    removeItem(i) {\n      this.removeFromParent(i);\n      this.categoriesMap.delete(i.category_id);\n    }\n    // relocateItem is to remove item from parent without losing its map reference\n    removeFromParent(cat) {\n      const pos = cat.siblings.indexOf(cat);\n      if (pos < 0) {\n        return;\n      }\n      cat.siblings.splice(pos, 1);\n    }\n    removeSelectedItem() {\n      const i = this.selectedItem;\n      this.selectedItem = null;\n      this.removeItem(i);\n    }\n    selectItem(item) {\n      this.selectedItem = item;\n    }\n    moveUp(cat) {\n      this.move(cat, cat.siblings, -1);\n      cat.direction = Move.Up;\n      const reqItem = sanitizeItem(cat);\n      return this.catServ.moveCategory(reqItem);\n    }\n    moveDown(cat) {\n      this.move(cat, cat.siblings, 1);\n      cat.direction = Move.Down;\n      const reqItem = sanitizeItem(cat);\n      return this.catServ.moveCategory(reqItem);\n    }\n    processCategories() {\n      const root = {\n        category_id: 0,\n        image: null,\n        name: 'Root',\n        children: this._categories\n      };\n      this.categoriesMap.set(0, root);\n      const addSiblings = parent => (cat, _, o) => {\n        cat.siblings = o;\n        this.categoriesMap.set(cat.category_id, cat);\n        if (!cat.children) {\n          return;\n        }\n        cat.children.forEach(addSiblings(cat));\n      };\n      this._categories.forEach(addSiblings(root));\n    }\n    configEvents() {\n      const delay = 300;\n      this.moveDownSubj.pipe(takeUntil(this.destroyed$), debounceTime(delay), concatMap(a => this.moveDown(a)), catchError((_, o) => o)).subscribe();\n      this.moveUpSubj.pipe(takeUntil(this.destroyed$), debounceTime(delay), concatMap(a => this.moveUp(a)), catchError((_, o) => o)).subscribe();\n    }\n    move(ele, arr, delta) {\n      const index = arr.indexOf(ele);\n      const newIndex = index + delta;\n      if (newIndex < 0 || newIndex === arr.length) {\n        return;\n      } // Already at the top or bottom.\n      const indexes = [index, newIndex].sort(); // Sort the indexes\n      arr.splice(indexes[0], 2, arr[indexes[1]], arr[indexes[0]]); // Replace from lowest index, two elements, reverting the order\n    }\n    static #_ = this.ɵfac = function CategoryComponent_Factory(t) {\n      return new (t || CategoryComponent)(i0.ɵɵdirectiveInject(i1.NgbModal), i0.ɵɵdirectiveInject(i2.AlertService), i0.ɵɵdirectiveInject(i3.ActivatedRoute), i0.ɵɵdirectiveInject(i4.StoreService), i0.ɵɵdirectiveInject(i5.CategoryService), i0.ɵɵdirectiveInject(i6.AuthService));\n    };\n    static #_2 = this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n      type: CategoryComponent,\n      selectors: [[\"app-category\"]],\n      features: [i0.ɵɵInheritDefinitionFeature],\n      decls: 7,\n      vars: 4,\n      consts: [[1, \"category\", \"p-4\", \"container\", \"direction-right\"], [1, \"row\", \"bg-light-gray\", \"rounded\"], [1, \"col-12\", \"p-4\"], [\"class\", \"control-section\", 4, \"ngIf\"], [\"class\", \"bg-primary\", 4, \"ngIf\"], [1, \"bg-super-light\", \"p-3\"], [3, \"selectedItemChange\", \"data\", \"selectedItem\"], [1, \"control-section\"], [1, \"d-flex\", \"justify-content-between\", \"align-items-center\"], [1, \"px-0\", \"col-auto\"], [1, \"btn\", \"btn-primary\", \"px-4\", \"px-lg-5\", 2, \"direction\", \"ltr\", 3, \"click\"], [\"aria-hidden\", \"true\", 1, \"fa\", \"fa-plus\"], [1, \"d-none\", \"d-md-flex\", \"col-3\"], [1, \"d-flex\", \"col-auto\"], [1, \"col-auto\"], [\"role\", \"button\", \"aria-hidden\", \"true\", 1, \"fa\", \"fa-2x\", \"fa-angle-up\", \"text-primary\", 3, \"click\"], [\"role\", \"button\", 1, \"fa\", \"fa-2x\", \"fa-angle-down\", \"text-primary\", 3, \"click\"], [1, \"col-auto\", \"pr-0\"], [1, \"d-flex\", \"align-items-center\"], [\"role\", \"button\", \"aria-hidden\", \"true\", 1, \"fas\", \"fa-lg\", \"fa-edit\", \"text-primary\", 3, \"click\"], [1, \"btn\", \"btn-primary\", \"px-3\", \"py-0\", 2, \"border-radius\", \"2rem\", 3, \"click\", \"disabled\"], [1, \"fas\", \"fa-lg\", \"fa-times\"], [1, \"bg-primary\"]],\n      template: function CategoryComponent_Template(rf, ctx) {\n        if (rf & 1) {\n          i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1)(2, \"div\", 2);\n          i0.ɵɵtemplate(3, CategoryComponent_div_3_Template, 19, 12, \"div\", 3)(4, CategoryComponent_hr_4_Template, 1, 0, \"hr\", 4);\n          i0.ɵɵelementStart(5, \"div\", 5)(6, \"app-category-list\", 6);\n          i0.ɵɵtwoWayListener(\"selectedItemChange\", function CategoryComponent_Template_app_category_list_selectedItemChange_6_listener($event) {\n            i0.ɵɵtwoWayBindingSet(ctx.selectedItem, $event) || (ctx.selectedItem = $event);\n            return $event;\n          });\n          i0.ɵɵelementEnd()()()()();\n        }\n        if (rf & 2) {\n          i0.ɵɵadvance(3);\n          i0.ɵɵproperty(\"ngIf\", ctx.isAdmin);\n          i0.ɵɵadvance();\n          i0.ɵɵproperty(\"ngIf\", ctx.isAdmin);\n          i0.ɵɵadvance(2);\n          i0.ɵɵproperty(\"data\", ctx.categories);\n          i0.ɵɵtwoWayProperty(\"selectedItem\", ctx.selectedItem);\n        }\n      },\n      dependencies: [i7.NgIf, i8.CategoryListComponent, i9.TranslatePipe],\n      encapsulation: 2\n    });\n  }\n  return CategoryComponent;\n})();\nconst sanitizeItem = fieldRemover(['name', 'parent_category_id', 'isOpen', 'children', 'children', 'siblings', 'image']);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}